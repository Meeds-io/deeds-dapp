<?xml version="1.0" encoding="UTF-8"?>
<!--

  This file is part of the Meeds project (https://meeds.io/).
  Copyright (C) 2022 Meeds Association contact@meeds.io
  This program is free software; you can redistribute it and/or
  modify it under the terms of the GNU Lesser General Public
  License as published by the Free Software Foundation; either
  version 3 of the License, or (at your option) any later version.
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  Lesser General Public License for more details.
  You should have received a copy of the GNU Lesser General Public License
  along with this program; if not, write to the Free Software Foundation,
  Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

-->
<configuration scan="false" debug="false">
  <!-- Enable JMX to configure logs -->
  <jmxConfigurator />
  <!-- Default pattern used for printing logs in files and on the console for systems that doesn't support a colorized output -->
  <property name="meeds.logs.default.pattern" value="%date{ISO8601} | %-5level | %msg [%logger{40}&lt;%thread&gt;] %n%xEx" />
  <!-- Pattern used for console supporting ANSI colors -->
  <property name="meeds.logs.colorized.pattern" value="%date{ISO8601} | %highlight(%-5level) | %msg %green([%logger{40}){}%cyan(&lt;%thread&gt;){}%green(]){} %n%xEx" />
  <!-- Logs are daily archived or whenever the file size reaches maxFileSize -->
  <property name="meeds.logs.rolling.maxFileSize" value="100Mb" />
  <!-- Number of archives to keep -->
  <property name="meeds.logs.rolling.maxHistory" value="60" />
  <!-- colorized console output -->
  <property name="meeds.logs.colorized.console" value="true" />
  <!--
  LevelChangePropagator propagates changes made to the level of any logback-classic logger onto the java.util.logging framework.
  Such propagation eliminates the performance impact of disabled log statements.
  -->
  <contextListener class="ch.qos.logback.classic.jul.LevelChangePropagator">
    <resetJUL>true</resetJUL>
  </contextListener>
  <logger name="io.meeds" level="INFO" />
  <logger name="org.apache.tomcat.util.digester.Digester" level="ERROR" />
  <logger name="org.apache.catalina.realm.JAASRealm" level="ERROR"/>
  <!--
  Main logs file for platform
  -->
  <appender name="FILE_PLATFORM_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>${catalina.base}/logs/platform.log</file>
    <append>true</append>
    <encoder>
      <pattern>${meeds.logs.default.pattern}</pattern>
      <outputPatternAsHeader>true</outputPatternAsHeader>
    </encoder>
    <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
      <!-- daily rollover -->
      <fileNamePattern>${catalina.base}/logs/platform-%d{yyyyMMdd}-%i.log.zip</fileNamePattern>
      <!-- Max number of archives to keep -->
      <maxHistory>${meeds.logs.rolling.maxHistory}</maxHistory>
      <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
        <!-- or whenever the file size reaches maxFileSize -->
        <maxFileSize>${meeds.logs.rolling.maxFileSize}</maxFileSize>
      </timeBasedFileNamingAndTriggeringPolicy>
    </rollingPolicy>
  </appender>
  <appender name="ASYNC_PLATFORM_LOG" class="ch.qos.logback.classic.AsyncAppender">
    <!-- Increase blocking queue capacity - 256 by default -->
    <queueSize>512</queueSize>
    <!-- Do not loose any event -->
    <discardingThreshold>0</discardingThreshold>
    <appender-ref ref="FILE_PLATFORM_LOG" />
  </appender>
  <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
    <withJansi>${meeds.logs.jansi.console:-false}</withJansi>
    <encoder>
      <pattern>${meeds.logs.colorized.pattern}</pattern>
    </encoder>
  </appender>
  <root level="INFO">
    <appender-ref ref="ASYNC_PLATFORM_LOG" />
    <appender-ref ref="CONSOLE" />
  </root>
</configuration>
